<!-- Arquivo: public/index.html -->
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Tabuada</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1,
        h2 {
            color: #2c3e50;
            text-align: center;
        }

        input,
        button,
        select {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .question {
            font-size: 24px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }

        .result {
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }

        .correct {
            color: #27ae60;
        }

        .incorrect {
            color: #e74c3c;
        }

        .score {
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .timer {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #e74c3c;
        }

        .operacao-info {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3498db;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Jogo da Tabuada</h1>

        <!-- Tela inicial -->
        <div id="inicio">
            <div class="form-group">
                <label for="nome">Nome:</label>
                <input type="text" id="nome" placeholder="Digite seu nome">
            </div>

           <!-- <div class="form-group">
                <label for="numPerguntas">N√∫mero de perguntas:</label>
                <input type="number" id="numPerguntas" min="1" max="20" value="10">
            </div>
            -->

            <button id="comecar">Come√ßar</button>
        </div>

        <!-- Tela do jogo -->
        <div id="jogo" class="hidden">
            <h2 id="jogadorInfo"></h2>
            <div id="operacaoInfo" class="operacao-info"></div>
            <div id="timer" class="timer">Tempo: 10</div>
            <div id="pergunta" class="question"></div>
            <div style="text-align: center;">
                <input type="number" id="resposta" placeholder="Sua resposta">
                <button id="confirmar">Confirmar</button>
            </div>
            <div id="feedback" class="result"></div>
            <div id="progresso" style="text-align: center;">Pergunta: <span id="atual">1</span>/<span
                    id="total">10</span></div>
        </div>

        <!-- Tela final -->
        <div id="fim" class="hidden">
            <h2>Jogo Finalizado!</h2>
            <div id="pontuacaoFinal" class="score"></div>
            <div style="text-align: center;">
                <button id="reiniciar">Jogar Novamente</button>
                <button id="verRanking">Ver Ranking</button>
            </div>
        </div>

        <!-- Tela de ranking -->
        <div id="ranking" class="hidden">
            <h2>Ranking dos Jogadores</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="voltarInicio">Voltar</button>
            </div>
            <table id="rankingTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Pontua√ß√£o</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Elementos da interface
        const telaInicio = document.getElementById('inicio');
        const telaJogo = document.getElementById('jogo');
        const telaFim = document.getElementById('fim');
        const telaRanking = document.getElementById('ranking');

        // Bot√µes
        const btnComecar = document.getElementById('comecar');
        const btnConfirmar = document.getElementById('confirmar');
        const btnReiniciar = document.getElementById('reiniciar');
        const btnVerRanking = document.getElementById('verRanking');
        const btnVoltarInicio = document.getElementById('voltarInicio');

        // Campos de entrada e exibi√ß√£o
        const inputNome = document.getElementById('nome');
        const inputPerguntas = document.getElementById('numPerguntas');
        const inputResposta = document.getElementById('resposta');
        const jogadorInfo = document.getElementById('jogadorInfo');
        const operacaoInfo = document.getElementById('operacaoInfo');
        const timerDiv = document.getElementById('timer');
        const perguntaDiv = document.getElementById('pergunta');
        const feedbackDiv = document.getElementById('feedback');
        const progressoAtual = document.getElementById('atual');
        const progressoTotal = document.getElementById('total');
        const pontuacaoFinalDiv = document.getElementById('pontuacaoFinal');
        const rankingBody = document.getElementById('rankingBody');

        // Vari√°veis do jogo
        let nomeJogador = '';
        let numPerguntas = 10;
        let perguntaAtual = 0;
        let pontuacao = 0;
        let perguntaCorreta = 0;
        let numeroA = 0;
        let numeroB = 0;
        let tempoRestante = 10;
        let timerInterval = null;
        let configuracoes = {
            operacaoAtual: 'multiplicacao',
            tabuadaAtual: 'random',
            tempoLimite: 10,
            numeroQuestoes: 10
        };
        let operacoesTexto = {
            multiplicacao: 'Multiplica√ß√£o',
            divisao: 'Divis√£o',
            soma: 'Soma',
            subtracao: 'Subtra√ß√£o'
        };
        let simbolosOperacao = {
            multiplicacao: '√ó',
            divisao: '√∑',
            soma: '+',
            subtracao: '‚àí'
        };

        // Event listeners
        btnComecar.addEventListener('click', iniciarJogo);
        btnConfirmar.addEventListener('click', verificarResposta);
        btnReiniciar.addEventListener('click', voltarInicio);
        btnVerRanking.addEventListener('click', carregarRanking);
        btnVoltarInicio.addEventListener('click', voltarInicio);

        // Permitir pressionar Enter para confirmar resposta
        inputResposta.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                verificarResposta();
            }
        });

        // Carregar configura√ß√µes ao iniciar a p√°gina
        window.addEventListener('load', carregarConfiguracoes);

        function carregarConfiguracoes() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    configuracoes = data;
                })
                .catch(error => {
                    console.error('Erro ao carregar configura√ß√µes:', error);
                });
        }

        function iniciarJogo() {
            nomeJogador = inputNome.value.trim();

            if (!nomeJogador) {
                alert('Por favor, digite seu nome!');
                return;
            }

            numPerguntas = configuracoes.numeroQuestoes || 10;  // Pega o n√∫mero de quest√µes definido pelo professor ou 10 como padr√£o

            jogadorInfo.textContent = `Jogador: ${nomeJogador}`;
            progressoTotal.textContent = numPerguntas;

            perguntaAtual = 0;
            pontuacao = 0;

            telaInicio.classList.add('hidden');
            telaFim.classList.add('hidden');
            telaRanking.classList.add('hidden');
            telaJogo.classList.remove('hidden');

            // Mostrar tipo de opera√ß√£o atual
            operacaoInfo.textContent = `Opera√ß√£o: ${operacoesTexto[configuracoes.operacaoAtual]}`;

            proximaPergunta();
        }

        function proximaPergunta() {
            perguntaAtual++;
            progressoAtual.textContent = perguntaAtual;

            // Definir n√∫meros para a pergunta
            if (configuracoes.tabuadaAtual === 'random') {
                numeroA = Math.floor(Math.random() * 10) + 1;
            } else {
                numeroA = parseInt(configuracoes.tabuadaAtual);
            }
            numeroB = Math.floor(Math.random() * 10) + 1;

            if (['divisao', 'subtracao', 'soma'].includes(configuracoes.operacaoAtual)) {
                numeroB = numeroA * numeroB;
            } else {
                // Para soma, mant√©m o comportamento original
                numeroB = Math.floor(Math.random() * 10) + 1;
            }

            // Calcular resultado correto baseado no tipo de opera√ß√£o
            switch (configuracoes.operacaoAtual) {
                case 'multiplicacao':
                    perguntaCorreta = numeroA * numeroB;
                    break;
                case 'divisao':
                    // Para divis√£o, garantimos que o resultado seja um n√∫mero inteiro
                    perguntaCorreta = numeroB / numeroA; // Assim, A √∑ B sempre dar√° um resultado inteiro
                    break;
                case 'soma':
                    perguntaCorreta = numeroA + numeroB;
                    break;
                case 'subtracao':
                    // Para subtra√ß√£o, garantimos que o resultado seja positivo
                    if (numeroA < numeroB) {
                        [numeroA, numeroB] = [numeroB, numeroA]; // Invertemos para resultado positivo
                    }
                    perguntaCorreta = numeroA - numeroB;
                    break;
            }

            // Exibir a pergunta com o s√≠mbolo correto da opera√ß√£o
            perguntaDiv.textContent = configuracoes.operacaoAtual === 'divisao' 
            ? `${numeroB} ${simbolosOperacao[configuracoes.operacaoAtual]} ${numeroA} = ?`
            : `${numeroA} ${simbolosOperacao[configuracoes.operacaoAtual]} ${numeroB} = ?`;


            inputResposta.value = '';
            feedbackDiv.textContent = '';
            inputResposta.focus();

            // Iniciar o temporizador
            iniciarTemporizador();
        }

        function iniciarTemporizador() {
            // Limpar timer anterior se existir
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Definir tempo baseado na configura√ß√£o
            tempoRestante = configuracoes.tempoLimite;
            timerDiv.textContent = `Tempo: ${tempoRestante}`;

            // Iniciar a contagem regressiva
            timerInterval = setInterval(() => {
                tempoRestante--;
                timerDiv.textContent = `Tempo: ${tempoRestante}`;

                if (tempoRestante <= 0) {
                    clearInterval(timerInterval);
                    // Tempo esgotado, marcar como erro
                    feedbackDiv.textContent = `Tempo esgotado! A resposta correta √© ${perguntaCorreta}.`;
                    feedbackDiv.className = 'result incorrect';

                    // Passar para pr√≥xima pergunta ap√≥s um breve momento
                    setTimeout(() => {
                        if (perguntaAtual < numPerguntas) {
                            proximaPergunta();
                        } else {
                            finalizarJogo();
                        }
                    }, 1500);
                }
            }, 1000);
        }

        function verificarResposta() {
            // Parar o timer
            clearInterval(timerInterval);

            const resposta = parseInt(inputResposta.value);

            if (isNaN(resposta)) {
                feedbackDiv.textContent = 'Por favor, digite um n√∫mero!';
                feedbackDiv.className = 'result incorrect';
                // Reiniciar o temporizador
                iniciarTemporizador();
                return;
            }

            if (resposta === perguntaCorreta) {
                feedbackDiv.textContent = 'Correto! üëç';
                feedbackDiv.className = 'result correct';
                pontuacao++;
            } else {
                feedbackDiv.textContent = `Incorreto! A resposta correta √© ${perguntaCorreta}.`;
                feedbackDiv.className = 'result incorrect';
            }

            // Esperar um pouco para mostrar o feedback
            setTimeout(() => {
                if (perguntaAtual < numPerguntas) {
                    proximaPergunta();
                } else {
                    finalizarJogo();
                }
            }, 1500);
        }

        function finalizarJogo() {
            // Parar o timer se ainda estiver rodando
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            telaJogo.classList.add('hidden');
            telaFim.classList.remove('hidden');

            const percentual = (pontuacao / numPerguntas * 100).toFixed(0);
            pontuacaoFinalDiv.textContent = `${nomeJogador}, voc√™ acertou ${pontuacao} de ${numPerguntas} (${percentual}%)`;

            // Enviar pontua√ß√£o para o servidor
            fetch('/api/ranking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome: nomeJogador,
                    pontuacao: pontuacao,
                    total: numPerguntas,
                    percentual: percentual,
                    data: new Date().toLocaleDateString()
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Pontua√ß√£o salva com sucesso:', data);
                })
                .catch(error => {
                    console.error('Erro ao salvar pontua√ß√£o:', error);
                });
        }

        function carregarRanking() {
            telaFim.classList.add('hidden');
            telaRanking.classList.remove('hidden');

            // Limpar tabela
            rankingBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';

            // Carregar ranking do servidor
            fetch('/api/ranking')
                .then(response => response.json())
                .then(data => {
                    rankingBody.innerHTML = '';

                    // Mostrar apenas os 20 melhores
                    const topRanking = data.slice(0, 20);

                    if (topRanking.length === 0) {
                        rankingBody.innerHTML = '<tr><td colspan="3">Nenhum registro encontrado</td></tr>';
                        return;
                    }

                    topRanking.forEach((item, index) => {
                        const row = document.createElement('tr');

                        const nomeCell = document.createElement('td');
                        nomeCell.textContent = item.nome;

                        const pontuacaoCell = document.createElement('td');
                        pontuacaoCell.textContent = `${item.pontuacao}/${item.total} (${item.percentual}%)`;

                        const dataCell = document.createElement('td');
                        dataCell.textContent = item.data;

                        row.appendChild(nomeCell);
                        row.appendChild(pontuacaoCell);
                        row.appendChild(dataCell);

                        rankingBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar ranking:', error);
                    rankingBody.innerHTML = '<tr><td colspan="3">Erro ao carregar dados</td></tr>';
                });
        }

        function voltarInicio() {
            // Parar o timer se ainda estiver rodando
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            telaJogo.classList.add('hidden');
            telaFim.classList.add('hidden');
            telaRanking.classList.add('hidden');
            telaInicio.classList.remove('hidden');

            // Recarregar configura√ß√µes
            carregarConfiguracoes();
        }
    </script>
</body>

</html>